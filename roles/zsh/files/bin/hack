#!/usr/bin/env bash
#
# hack - Set up a stacked branch worktree with a full tmux session
#
# Usage: hack <branch-name>

set -e

# --- Help -------------------------------------------------------------------

display_help() {
  cat << 'EOF'
hack - Set up a stacked branch worktree with a full tmux session

Usage: hack [options] <branch-name>

Options:
  -h, --help     Display this help message and exit

Creates a stacked branch (via git-town append), a worktree, and a tmux
session with three windows: nvim, claude, and zsh.

The tmux session gets a random adjective-animal name. The summary printed
before attaching maps the session name back to the branch.

Example:
  hack feat/add-auth
  hack fix/null-pointer
EOF
  exit 0
}

# --- Arg parsing -------------------------------------------------------------

if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
  display_help
fi

if [ $# -ne 1 ]; then
  echo "Error: expected exactly one argument: <branch-name>"
  echo "Usage: hack <branch-name>"
  exit 1
fi

BRANCH="$1"

# --- Prereq checks ----------------------------------------------------------

if ! git rev-parse --is-inside-work-tree &>/dev/null; then
  echo "Error: not inside a git repository"
  exit 1
fi

if ! command -v git-town &>/dev/null; then
  echo "Error: git-town is not installed (brew install git-town)"
  exit 1
fi

if ! command -v tmux &>/dev/null; then
  echo "Error: tmux is not installed (brew install tmux)"
  exit 1
fi

# --- Helpers -----------------------------------------------------------------

REPO_ROOT=$(git rev-parse --show-toplevel)

find_worktree_for_branch() {
  local target_branch="$1"
  local wt_path=""

  while IFS= read -r line; do
    case "$line" in
      "worktree "*)
        wt_path="${line#worktree }"
        ;;
      "branch refs/heads/$target_branch")
        # Only match worktrees under .worktrees/, not the main worktree
        case "$wt_path" in
          "$REPO_ROOT/.worktrees/"*)
            echo "$wt_path"
            return 0
            ;;
        esac
        ;;
      "")
        wt_path=""
        ;;
    esac
  done < <(git worktree list --porcelain)

  return 1
}

find_session_for_worktree() {
  local wt_path="$1"

  tmux list-panes -a -F '#{session_name} #{pane_current_path}' 2>/dev/null | while IFS=' ' read -r session pane_path; do
    case "$pane_path" in
      "$wt_path"|"$wt_path"/*)
        echo "$session"
        return 0
        ;;
    esac
  done
}

# --- Branch ------------------------------------------------------------------

CURRENT=$(git branch --show-current)

if git show-ref --verify --quiet "refs/heads/$BRANCH"; then
  echo "Branch '$BRANCH' already exists, reusing."
else
  git town append "$BRANCH"
  git checkout "$CURRENT"
fi

# --- Worktree ----------------------------------------------------------------

WORKTREE_PATH=$(find_worktree_for_branch "$BRANCH" || true)

if [ -n "$WORKTREE_PATH" ]; then
  WORKTREE_NAME=$(basename "$WORKTREE_PATH")
  echo "Worktree already exists at .worktrees/$WORKTREE_NAME, reusing."
else
  # --- Name generation -------------------------------------------------------

  ADJECTIVES=(
    amber bold bright calm clever cool cosmic crisp dark deft
    eager fast fierce gentle golden grand hazy keen light lunar
    mellow misty noble pale plain prime quick quiet rapid raw
    sharp silent sleek slim smooth solar steady stout swift tall
    terse tidy vivid warm wild young agile blunt brisk clean
    clear dense dusty fresh ivory jade lucid nifty opal radiant
  )

  ANIMALS=(
    badger bear cat crane crow deer dolphin eagle elk falcon
    ferret finch fox gecko goat hawk heron horse ibis jackal
    jay kite lemur lion lynx moose newt otter owl parrot
    puma quail raven robin seal shark shrike snake sparrow spider
    squid stork swan tern tiger toad viper walrus wren yak
    ant bat cod crab drake egret frog grouse gull hare
  )

  generate_name() {
    local adj="${ADJECTIVES[$((RANDOM % ${#ADJECTIVES[@]}))]}"
    local animal="${ANIMALS[$((RANDOM % ${#ANIMALS[@]}))]}"
    echo "${adj}-${animal}"
  }

  WORKTREE_NAME=""
  for _ in $(seq 1 10); do
    CANDIDATE=$(generate_name)
    if [ ! -d "$REPO_ROOT/.worktrees/$CANDIDATE" ]; then
      WORKTREE_NAME="$CANDIDATE"
      break
    fi
  done

  if [ -z "$WORKTREE_NAME" ]; then
    echo "Error: failed to generate a unique worktree name after 10 attempts"
    exit 1
  fi

  mkdir -p "$REPO_ROOT/.worktrees"
  git worktree add "$REPO_ROOT/.worktrees/$WORKTREE_NAME" "$BRANCH"

  WORKTREE_PATH="$REPO_ROOT/.worktrees/$WORKTREE_NAME"

  # Symlink .claude so the worktree inherits permissions and settings
  if [ -d "$REPO_ROOT/.claude" ] && [ ! -e "$WORKTREE_PATH/.claude" ]; then
    ln -s "$REPO_ROOT/.claude" "$WORKTREE_PATH/.claude"
  fi
fi

# --- Tmux session ------------------------------------------------------------

EXISTING_SESSION=$(find_session_for_worktree "$WORKTREE_PATH" || true)

if [ -n "$EXISTING_SESSION" ]; then
  echo "Session '$EXISTING_SESSION' already exists, switching."
  echo ""
  echo "  Branch:   $BRANCH"
  echo "  Worktree: .worktrees/$WORKTREE_NAME"
  echo "  Session:  $EXISTING_SESSION"
  echo ""

  if [ -n "$TMUX" ]; then
    tmux switch-client -t "$EXISTING_SESSION"
  else
    tmux attach-session -t "$EXISTING_SESSION"
  fi
  exit 0
fi

if [ -n "$TMUX" ]; then
  PARENT_SESSION=$(tmux display-message -p '#S')
  SESSION="${PARENT_SESSION}/${WORKTREE_NAME}"
else
  SESSION="$WORKTREE_NAME"
fi

tmux new-session -d -s "$SESSION" -n "nvim" -c "$WORKTREE_PATH"
tmux send-keys -t "$SESSION:nvim" "nvim" Enter

tmux new-window -t "$SESSION" -n "claude" -c "$WORKTREE_PATH"
tmux send-keys -t "$SESSION:claude" "claude --permission-mode plan '/hack'" Enter

tmux new-window -t "$SESSION" -n "zsh" -c "$WORKTREE_PATH"

tmux select-window -t "$SESSION:nvim"

# --- Summary -----------------------------------------------------------------

echo ""
echo "  Branch:   $BRANCH (stacked on $CURRENT)"
echo "  Worktree: .worktrees/$WORKTREE_NAME"
echo "  Session:  $SESSION"
echo ""

# --- Attach ------------------------------------------------------------------

if [ -n "$TMUX" ]; then
  tmux switch-client -t "$SESSION"
else
  tmux attach-session -t "$SESSION"
fi
